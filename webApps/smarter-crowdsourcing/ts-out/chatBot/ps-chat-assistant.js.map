{"version":3,"file":"ps-chat-assistant.js","sourceRoot":"","sources":["../../src/chatBot/ps-chat-assistant.ts"],"names":[],"mappings":"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","sourcesContent":["import { PropertyValueMap, css, html, nothing } from 'lit';\nimport { property, customElement, query, queryAll } from 'lit/decorators.js';\n\nimport '@material/web/fab/fab.js';\n\nimport '@material/web/radio/radio.js';\nimport '@material/web/button/elevated-button.js';\nimport '@material/web/button/text-button.js';\nimport '@material/web/button/outlined-button.js';\nimport '@material/web/button/filled-button.js';\nimport '@material/web/textfield/outlined-text-field.js';\nimport '@material/web/icon/icon.js';\n\nimport { MdDialog } from '@material/web/dialog/dialog.js';\n\nimport '@material/web/iconbutton/outlined-icon-button.js';\n\nimport '@yrpri/webapp/common/yp-image.js';\nimport { PsAiChatElement } from './ps-ai-chat-element.js';\nimport { MdFilledTonalButton } from '@material/web/button/filled-tonal-button.js';\nimport { MdOutlinedTextField } from '@material/web/textfield/outlined-text-field.js';\n\nimport { BaseChatBotServerApi } from './BaseChatBotApi.js';\nimport './ps-ai-chat-element.js';\nimport { YpBaseElement } from '@yrpri/webapp/common/yp-base-element.js';\n\nconst PROMPT_DEBUG = true;\n\n@customElement('ps-chat-assistant')\nexport class PsChatAssistant extends YpBaseElement {\n  @property({ type: Array })\n  chatLog: PsAiChatWsMessage[] = [];\n\n  @property({ type: String })\n  infoMessage!: string;\n\n  @property({ type: String })\n  wsClientId!: string;\n\n  @property({ type: Number })\n  webSocketsErrorCount = 0;\n\n  @property({ type: String })\n  defaultInfoMessage: string = \"I'm your friendly chat assistant\";\n\n  @property({ type: String })\n  wsEndpoint!: string;\n\n  @property({ type: Object })\n  ws!: WebSocket;\n\n  @property({ type: Boolean })\n  inputIsFocused = false;\n\n  @property({ type: Boolean })\n  onlyUseTextField = false;\n\n  @property({ type: Object })\n  currentDocumentSourceToDisplay: PsSimpleDocumentSource | undefined;\n\n  @property({ type: Number })\n  clusterId!: number;\n\n  @property({ type: Boolean })\n  userScrolled = false;\n\n  @property({ type: Number })\n  communityId!: number;\n\n  @property({ type: String })\n  textInputLabel!: string;\n\n  @property({ type: String })\n  currentFollowUpQuestions: string = '';\n\n  @property({ type: Boolean })\n  programmaticScroll = false;\n\n  @property({ type: Boolean })\n  showCleanupButtonAtBottom = false;\n\n  @property({ type: Number })\n  scrollStart: number = 0;\n\n  @property({ type: String })\n  serverMemoryId: string | undefined;\n\n  @property({ type: Number })\n  defaultDevWsPort = 8000;\n\n  @query('#sendButton')\n  sendButton?: MdFilledTonalButton;\n\n  @queryAll('ps-ai-chat-element')\n  chatElements?: PsAiChatElement[];\n\n  @query('#chatInput')\n  chatInputField?: MdOutlinedTextField;\n\n  @query('#chat-window')\n  chatWindow?: HTMLElement;\n\n  @query('#chat-messages')\n  chatMessagesElement?: HTMLElement;\n\n  api: BaseChatBotServerApi;\n  heartbeatInterval: number | undefined;\n\n  constructor() {\n    super();\n    this.api = new BaseChatBotServerApi();\n  }\n\n  calcVH() {\n    const vH = Math.max(\n      document.documentElement.clientHeight,\n      window.innerHeight || 0\n    );\n    this.chatWindow!.setAttribute('style', 'height:' + vH + 'px;');\n  }\n\n  handleCtrlPKeyPress(event: KeyboardEvent) {\n    if ((event.ctrlKey || event.metaKey) && event.altKey && event.key === 'c') {\n      this.copyLatestDebugInfoToClipboard();\n      event.preventDefault();\n    }\n  }\n\n  copyLatestDebugInfoToClipboard() {\n    const latestChatMessage = this.chatLog[this.chatLog.length - 1];\n    if (latestChatMessage && latestChatMessage.debug) {\n      const systemPrompt =\n        latestChatMessage.debug.systemPromptUsedForGeneration || '';\n      const firstUserPrompt =\n        latestChatMessage.debug.firstUserMessageUserForGeneration || '';\n      const debugInfo = `${systemPrompt}\\n\\n-------------------------\\n\\n${firstUserPrompt}`;\n\n      navigator.clipboard\n        .writeText(debugInfo)\n        .then(() => console.log('Debug info copied to clipboard!'))\n        .catch(err => console.error('Failed to copy debug info:', err));\n    }\n  }\n\n  override connectedCallback() {\n    super.connectedCallback();\n\n    const a = { name: 'test' } as YpGroupConfiguration;\n\n    if (PROMPT_DEBUG) {\n      document.addEventListener('keydown', this.handleCtrlPKeyPress.bind(this));\n    }\n\n    this.initWebSockets();\n  }\n\n  initWebSockets() {\n    let wsEndpoint;\n\n    if (\n      window.location.hostname === 'localhost' ||\n      window.location.hostname === '192.1.168'\n    ) {\n      wsEndpoint = `ws://${window.location.hostname}:${this.defaultDevWsPort}`;\n    } else {\n      wsEndpoint = `wss://${window.location.hostname}:443`;\n    }\n\n    try {\n      this.ws = new WebSocket(wsEndpoint);\n      console.error('WebSocket Opened');\n      this.ws.onmessage = this.onMessage.bind(this);\n      this.ws.onopen = this.onWsOpen.bind(this);\n      this.ws.onerror = error => {\n        //TODO: Try to resend the last message\n        this.webSocketsErrorCount++;\n        console.error('WebSocket Error ' + error);\n        setTimeout(\n          () => this.initWebSockets(),\n          this.webSocketsErrorCount > 1\n            ? this.webSocketsErrorCount * 1000\n            : 2000\n        );\n      };\n      this.ws.onclose = error => {\n        console.error('WebSocket Close ' + error);\n        this.webSocketsErrorCount++;\n        setTimeout(\n          () => this.initWebSockets(),\n          this.webSocketsErrorCount > 1\n            ? this.webSocketsErrorCount * 1000\n            : 2000\n        );\n      };\n    } catch (error) {\n      console.error('WebSocket Error ' + error);\n      this.webSocketsErrorCount++;\n      setTimeout(\n        () => this.initWebSockets(),\n        this.webSocketsErrorCount > 1 ? this.webSocketsErrorCount * 1000 : 1500\n      );\n    }\n  }\n\n  protected override firstUpdated(\n    _changedProperties: PropertyValueMap<any> | Map<PropertyKey, unknown>\n  ): void {\n    // focus the text input\n    setTimeout(() => {\n      this.chatInputField!.focus();\n    }, 420);\n\n    setTimeout(() => {\n      this.chatMessagesElement!.addEventListener(\n        'scroll',\n        this.handleScroll.bind(this)\n      );\n    }, 500);\n  }\n\n  sendHeartbeat() {\n    if (this.ws.readyState === WebSocket.OPEN) {\n      this.ws.send(JSON.stringify({ type: 'heartbeat' }));\n    } else {\n      console.error('WebSocket not open');\n    }\n  }\n\n  onWsOpen() {\n    console.error('WebSocket onWsOpen');\n    this.sendHeartbeat();\n\n    //@ts-ignore\n    this.heartbeatInterval = setInterval(() => this.sendHeartbeat(), 55000);\n    this.ws.onmessage = messageEvent => {\n      const data = JSON.parse(messageEvent.data);\n      if (data.clientId) {\n        this.wsClientId = data.clientId;\n        this.ws.onmessage = this.onMessage.bind(this);\n        console.error(`WebSocket clientId: ${this.wsClientId}`);\n      } else {\n        console.error('Error: No clientId received from server!');\n      }\n    };\n  }\n\n  override updated(\n    changedProperties: Map<string | number | symbol, unknown>\n  ): void {\n    super.updated(changedProperties);\n    if (changedProperties.has('themeDarkMode')) {\n    }\n  }\n\n  handleScroll() {\n    if (this.programmaticScroll) {\n      return; // Skip handling if the scroll was initiated programmatically\n    }\n\n    const currentScrollTop = this.chatMessagesElement!.scrollTop;\n    if (this.scrollStart === 0) {\n      // Initial scroll\n      this.scrollStart = currentScrollTop;\n    }\n\n    const threshold = 10;\n    const atBottom =\n      this.chatMessagesElement!.scrollHeight -\n        currentScrollTop -\n        this.chatMessagesElement!.clientHeight <=\n      threshold;\n\n    if (atBottom) {\n      this.userScrolled = false;\n      this.scrollStart = 0; // Reset scroll start\n    } else if (Math.abs(this.scrollStart - currentScrollTop) > threshold) {\n      this.userScrolled = true;\n      // Optionally reset scrollStart here if you want to continuously check for threshold scroll\n      // this.scrollStart = currentScrollTop;\n    }\n  }\n\n  override disconnectedCallback(): void {\n    //    this.ws.close();\n    super.disconnectedCallback();\n\n    if (PROMPT_DEBUG) {\n      document.removeEventListener(\n        'keydown',\n        this.handleCtrlPKeyPress.bind(this)\n      );\n    }\n\n    if (this.chatMessagesElement) {\n      this.chatMessagesElement.removeEventListener(\n        'scroll',\n        this.handleScroll.bind(this)\n      );\n    }\n\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n  }\n\n  async onMessage(event: MessageEvent) {\n    const data: PsAiChatWsMessage = JSON.parse(event.data);\n    //console.error(event.data);\n\n    switch (data.sender) {\n      case 'bot':\n        this.addChatBotElement(data);\n        break;\n      case 'you':\n        this.addChatUserElement(data);\n        break;\n    }\n\n    if (this.chatLog.length > 1) {\n      this.textInputLabel = this.t('Ask a follow-up question');\n    }\n\n    if (data.type !== 'stream_followup') {\n      this.scrollDown();\n    }\n  }\n\n  scrollDown() {\n    if (!this.userScrolled) {\n      this.programmaticScroll = true; // Set the flag before scrolling\n      this.$$('#chat-messages')!.scrollTop =\n        this.$$('#chat-messages')!.scrollHeight;\n      setTimeout(() => {\n        this.programmaticScroll = false; // Reset the flag after scrolling\n      }, 100);\n    }\n  }\n\n  addUserChatBotMessage(userMessage: string) {\n    this.addChatBotElement({\n      sender: 'you',\n      type: 'start',\n      message: userMessage,\n    });\n  }\n\n  addThinkingChatBotMessage() {\n    this.addChatBotElement({\n      sender: 'bot',\n      type: 'thinking',\n      message: '',\n    });\n  }\n\n  addToChatLogWithMessage(\n    data: PsAiChatWsMessage,\n    message: string | undefined = undefined,\n    changeButtonDisabledState: boolean | undefined = undefined,\n    changeButtonLabelTo: string | undefined = undefined,\n    refinedCausesSuggestions: string[] | undefined = undefined,\n    rawMessage: string | undefined = undefined\n  ) {\n    this.infoMessage = message!;\n    data.refinedCausesSuggestions = refinedCausesSuggestions || [];\n    data.rawMessage = data.rawMessage || rawMessage;\n    this.chatLog = [...this.chatLog, data];\n\n    this.requestUpdate();\n\n    if (changeButtonDisabledState !== undefined) {\n      this.sendButton!.disabled = changeButtonDisabledState;\n    }\n\n    if (changeButtonLabelTo !== undefined) {\n      //this.sendButton!.innerHTML = changeButtonLabelTo;\n    }\n  }\n\n  get lastChatUiElement() {\n    return this.chatElements![this.chatElements!.length - 1];\n  }\n\n  async addChatBotElement(wsMessage: PsAiChatWsMessage) {\n    switch (wsMessage.type) {\n      case 'hello_message':\n        this.addToChatLogWithMessage(wsMessage);\n        break;\n      case 'thinking':\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.spinnerActive = false;\n        }\n        this.addToChatLogWithMessage(wsMessage, this.t('Thinking...'));\n        break;\n      case 'noStreaming':\n        this.addToChatLogWithMessage(wsMessage, wsMessage.message);\n        await this.updateComplete;\n        this.lastChatUiElement.spinnerActive = true;\n        break;\n      case 'agentStart':\n        console.log('agentStart');\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.spinnerActive = false;\n        }\n        const startOptions = wsMessage.data as PsAgentStartWsOptions;\n\n        setTimeout(() => {\n          this.scrollDown();\n        }, 50);\n\n        if (startOptions.noStreaming) {\n          this.addChatBotElement({\n            sender: 'bot',\n            type: 'noStreaming',\n            message: startOptions.name,\n          });\n        } else {\n          this.addToChatLogWithMessage(wsMessage, startOptions.name);\n          this.chatLog[\n            this.chatLog.length - 1\n          ].message = `${startOptions.name}\\n\\n`;\n        }\n        this.requestUpdate();\n        break;\n      case 'liveLlmCosts':\n        this.fire('llm-total-cost-update', wsMessage.data);\n        break;\n      case 'memoryIdCreated':\n        this.serverMemoryId = wsMessage.data as string;\n        this.fire('server-memory-id-created', wsMessage.data);\n        break;\n      case 'agentCompleted':\n        console.log('agentCompleted...');\n        const completedOptions = wsMessage.data as PsAgentCompletedWsOptions;\n\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.spinnerActive = false;\n          this.lastChatUiElement.message = completedOptions.name;\n        } else {\n          console.error('No last element on agentCompleted');\n        }\n        break;\n      case 'agentUpdated':\n        console.log('agentUpdated');\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.updateMessage = wsMessage.message;\n        } else {\n          console.error('No last element on agentUpdated');\n        }\n        break;\n      case 'start':\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.spinnerActive = false;\n        }\n        this.addToChatLogWithMessage(wsMessage, this.t('Thinking...'));\n        if (!this.chatLog[this.chatLog.length - 1].message)\n          this.chatLog[this.chatLog.length - 1].message = '';\n        break;\n      case 'start_followup':\n        this.lastChatUiElement.followUpQuestionsRaw = '';\n        break;\n      case 'stream_followup':\n        this.lastChatUiElement.followUpQuestionsRaw += wsMessage.message;\n        this.requestUpdate();\n        break;\n      case 'info':\n        if (wsMessage.message) {\n          this.infoMessage = wsMessage.message;\n        } else if (wsMessage.data) {\n          const data = wsMessage.data as PsRagDocumentSourcesWsData;\n          if (data.name === 'sourceDocuments') {\n            this.fire('source-documents', data.message);\n            this.addToChatLogWithMessage(wsMessage);\n          }\n          if (this.lastChatUiElement) {\n            this.lastChatUiElement.spinnerActive = false;\n          }\n        }\n        break;\n      case 'moderation_error':\n        wsMessage.message =\n          'OpenAI Moderation Flag Error. Please refine your question.';\n        this.addToChatLogWithMessage(\n          wsMessage,\n          wsMessage.message,\n          false,\n          this.t('Send')\n        );\n        break;\n      case 'error':\n        this.addToChatLogWithMessage(\n          wsMessage,\n          wsMessage.message,\n          false,\n          this.t('Send')\n        );\n        break;\n      case 'end':\n        this.lastChatUiElement.stopJsonLoading();\n        this.chatLog[this.chatLog.length - 1].debug = wsMessage.debug;\n        this.sendButton!.disabled = false;\n        this.sendButton!.innerHTML = this.t('Send');\n        this.infoMessage = this.defaultInfoMessage;\n        break;\n      case 'message':\n        if (this.lastChatUiElement) {\n          this.lastChatUiElement.spinnerActive = false;\n        }\n        this.addToChatLogWithMessage(\n          wsMessage,\n          wsMessage.message,\n          undefined,\n          undefined,\n          wsMessage.refinedCausesSuggestions\n        );\n        this.chatLog[this.chatLog.length - 1].refinedCausesSuggestions =\n          wsMessage.refinedCausesSuggestions;\n        this.sendButton!.disabled = false;\n        this.sendButton!.innerHTML = this.t('Send');\n        this.infoMessage = this.defaultInfoMessage;\n        this.requestUpdate();\n        break;\n      case 'stream':\n        if (wsMessage.message && wsMessage.message != 'undefined') {\n          //@ts-ignore\n          this.infoMessage = this.t('typing');\n          this.chatLog[this.chatLog.length - 1].message =\n            this.chatLog[this.chatLog.length - 1].message + wsMessage.message;\n          //console.error(this.chatLog[this.chatLog.length - 1].message)\n          this.requestUpdate();\n          break;\n        }\n    }\n\n    this.scrollDown();\n  }\n\n  addChatUserElement(data: PsAiChatWsMessage) {\n    this.chatLog = [...this.chatLog, data];\n  }\n\n  async sendChatMessage() {\n    const message = this.chatInputField!.value;\n\n    if (message.length === 0) return;\n\n    //this.ws.send(message);\n    this.chatInputField!.value = '';\n    this.sendButton!.disabled = false;\n    //this.sendButton!.innerHTML = this.t('Thinking...');\n    setTimeout(() => {\n      this.chatInputField!.blur();\n    });\n  }\n\n  get simplifiedChatLog() {\n    let chatLog = this.chatLog.filter(\n      chatMessage =>\n        chatMessage.type != 'thinking' &&\n        chatMessage.type != 'info' &&\n        chatMessage.type != 'noStreaming' &&\n        chatMessage.message\n    );\n    return chatLog.map(chatMessage => {\n      return {\n        sender: chatMessage.sender == 'bot' ? 'assistant' : 'user',\n        message: chatMessage.rawMessage\n          ? chatMessage.rawMessage\n          : chatMessage.message,\n      };\n    }) as PsSimpleChatLog[];\n  }\n\n  static override get styles() {\n    return [\n      super.styles,\n      css`\n        md-textfield {\n          width: 600px;\n          --mdc-theme-primary: var(--md-sys-color-primary);\n          --mdc-text-field-ink-color: var(--md-sys-color-on-surface);\n          --mdc-text-area-outlined-hover-border-color: var(\n            --md-sys-color-on-surface\n          );\n          --mdc-text-area-outlined-idle-border-color: var(\n            --md-sys-color-on-surface\n          );\n          --mdc-notched-outline-border-color: var(\n            --md-sys-color-on-surface-variant\n          );\n        }\n\n        md-outlined-text-field {\n          width: 350px;\n        }\n\n        .infoMessage {\n          margin-top: 8px;\n        }\n\n        .chat-window {\n          display: flex;\n          flex-direction: column;\n          height: 75vh;\n          width: 100%;\n          max-width: 1200px;\n          margin: 0 auto;\n          border-radius: 10px;\n          overflow: hidden;\n        }\n        .chat-messages {\n          display: flex;\n          flex-direction: column;\n          flex: 1;\n          padding: 20px;\n          overflow-y: scroll;\n        }\n\n        .you-chat-element {\n          align-self: flex-start;\n          max-width: 80%;\n          justify-content: flex-start;\n          margin-right: 32px;\n        }\n\n        .bot-chat-element {\n          align-self: flex-start;\n          justify-content: flex-start;\n          width: 100%;\n          max-width: 100%;\n        }\n\n        .chat-input {\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n          padding: 8px;\n        }\n\n        @media (max-width: 600px) {\n          .chat-window {\n          }\n\n          .you-chat-element {\n            margin-right: 0;\n          }\n        }\n\n        md-tonal-button {\n          padding: 16px;\n          padding-left: 0;\n          margin-top: 0;\n        }\n\n        .sendIcon {\n          cursor: pointer;\n        }\n\n        .restartButton {\n          margin-left: 16px;\n        }\n\n        .darkModeButton {\n          margin-right: 16px;\n        }\n\n        .currentSourceTitle {\n          font-size: 18px;\n          font-weight: bold;\n          margin-bottom: 4px;\n        }\n\n        .currentSourceDescription {\n          margin-top: 8px;\n          margin-bottom: 8px;\n        }\n\n        .sourceLinkButton {\n          margin-top: 16px;\n          margin-bottom: 320px;\n        }\n\n        .currentSourceUrl {\n          max-width: 40ch;\n          overflow: hidden;\n          text-overflow: ellipsis;\n          font-size: 12px;\n        }\n\n        md-outlined-text-field {\n          flex: 1;\n          border-radius: 10px;\n          border: none;\n          padding: 10px;\n          margin: 16px;\n          margin-bottom: 16px;\n          margin-left: 8px;\n          margin-right: 8px;\n          width: 650px;\n        }\n\n        .chatElement[thinking] {\n          margin-top: 16px;\n          margin-bottom: 8px;\n        }\n\n        @media (max-width: 960px) {\n          .restartButton {\n            margin-left: 8px;\n            display: none;\n          }\n\n          .darkModeButton {\n            margin-right: 8px;\n            display: none;\n          }\n\n          md-outlined-text-field {\n            transition: transform 0.5s;\n            width: 400px;\n          }\n\n          .restartButton[input-is-focused] {\n          }\n\n          .darkModeButton[input-is-focused] {\n          }\n\n          md-outlined-text-field[focused] {\n            width: 100%;\n          }\n        }\n\n        @media (max-width: 450px) {\n          md-outlined-text-field {\n            width: 350px;\n          }\n\n          md-outlined-text-field[focused] {\n            width: 100%;\n          }\n        }\n\n        @media (max-width: 400px) {\n          md-outlined-text-field {\n            width: 320px;\n          }\n\n          md-outlined-text-field[focused] {\n            width: 100%;\n          }\n        }\n      `,\n    ];\n  }\n\n  followUpQuestion(event: CustomEvent) {\n    this.chatInputField!.value = event.detail;\n    this.sendChatMessage();\n  }\n\n  reset() {\n    this.chatLog = [];\n    if (this.ws) {\n      this.ws.close();\n      this.initWebSockets();\n    }\n    this.serverMemoryId = undefined;\n    this.requestUpdate();\n  }\n\n  toggleDarkMode() {\n    this.themeDarkMode = !this.themeDarkMode;\n    this.fire('theme-dark-mode', this.themeDarkMode);\n    this.requestUpdate();\n  }\n\n  renderChatInput() {\n    return html`\n      ${this.showCleanupButtonAtBottom\n        ? html`\n        <md-outlined-icon-button\n          class=\"restartButton\"\n          @click=\"${() => this.fire('reset-chat')}\"\n        ><md-icon>refresh</md-icon></md-icon></md-outlined-icon-button>\n      `\n        : nothing}\n      ${this.onlyUseTextField || this.chatLog.length > 1\n        ? html`\n            <md-outlined-text-field\n              class=\"textInput\"\n              type=\"text\"\n              hasTrailingIcon\n              id=\"chatInput\"\n              rows=\"${this.chatLog.length > 1 ? '1' : '3'}\"\n              @focus=\"${() => (this.inputIsFocused = true)}\"\n              @blur=\"${() => (this.inputIsFocused = true)}\"\n              @keyup=\"${(e: KeyboardEvent) => {\n                if (e.key === 'Enter') {\n                  this.sendChatMessage();\n                }\n              }}\"\n              .label=\"${this.textInputLabel}\"\n            >\n              <md-icon\n                class=\"sendIcon\"\n                @click=\"${this.sendChatMessage}\"\n                slot=\"trailing-icon\"\n                id=\"sendButton\"\n                ?input-is-focused=\"${this.inputIsFocused}\"\n                >send</md-icon\n              >\n            </md-outlined-text-field>\n          `\n        : html`<md-outlined-text-field\n            class=\"textInput\"\n            type=\"textarea\"\n            hasTrailingIcon\n            id=\"chatInput\"\n            rows=\"3\"\n            @focus=\"${() => (this.inputIsFocused = true)}\"\n            @blur=\"${() => (this.inputIsFocused = true)}\"\n            .label=\"${this.textInputLabel}\"\n          >\n            <md-icon\n              class=\"sendIcon\"\n              @click=\"${this.sendChatMessage}\"\n              slot=\"trailing-icon\"\n              id=\"sendButton\"\n              ?input-is-focused=\"${this.inputIsFocused}\"\n              >send</md-icon\n            ></md-outlined-text-field\n          >`}\n    `;\n  }\n\n  cancelSourceDialog() {\n    this.currentDocumentSourceToDisplay = undefined;\n    const dialog = this.$$('#sourceDialog') as MdDialog;\n    dialog.open = false;\n  }\n\n  openSourceDialog(event: CustomEvent) {\n    this.currentDocumentSourceToDisplay = event.detail;\n    this.requestUpdate();\n    const dialog = this.$$('#sourceDialog') as MdDialog;\n    dialog.open = true;\n  }\n\n  stripDomainForFacIcon(url: string) {\n    let domain = url.split('/')[2];\n    console.error(`Domain is ${domain}`);\n    return domain;\n  }\n\n  renderSourceDialog() {\n    return html`\n      <md-dialog\n        id=\"sourceDialog\"\n        @closed=\"${() => this.cancelSourceDialog()}\"\n        ?fullscreen=\"${!this.wide}\"\n        class=\"dialog\"\n        id=\"dialog\"\n      >\n        ${this.currentDocumentSourceToDisplay\n          ? html` <div slot=\"headline\">\n                ${this.currentDocumentSourceToDisplay.title}\n              </div>\n              <div slot=\"content\" id=\"content\">\n                <div class=\"layout vertical\">\n                  <div class=\"layout horizontal center-center\">\n                    <img\n                      src=\"https://www.google.com/s2/favicons?domain=${this.stripDomainForFacIcon(\n                      this.currentDocumentSourceToDisplay.url\n                    )}&sz=24\"\n                      slot=\"icon\"\n                      width=\"24\"\n                      height=\"24\"\n                      class=\"sourceFavIcon\"\n                    />\n                  </div>\n                  <div class=\"currentSourceDescription\">\n                    ${this.currentDocumentSourceToDisplay\n                      .compressedFullDescriptionOfAllContents}\n                  </div>\n                  <div class=\"layout horizontal center-center sourceLinkButton\">\n                    ${this.currentDocumentSourceToDisplay.url\n                      .toLowerCase()\n                      .indexOf('.pdf') > -1\n                      ? html`\n                          <a\n                            href=\"${this.currentDocumentSourceToDisplay.url}\"\n                            target=\"_blank\"\n                            download\n                          >\n                            <md-filled-button>\n                              ${this.t('Open PDF')}\n                            </md-filled-button>\n                          </a>\n                        `\n                      : html`\n                          <a\n                            href=\"${this.currentDocumentSourceToDisplay.url}\"\n                            target=\"_blank\"\n                          >\n                            <md-filled-button>\n                              ${this.t('Visit Website')}\n                            </md-filled-button>\n                          </a>\n                        `}\n                  </div>\n                </div>\n              </div>`\n          : nothing}\n        <div slot=\"actions\">\n          <md-text-button @click=\"${() => this.cancelSourceDialog()}\">\n            ${this.t('cancel')}\n          </md-text-button>\n        </div>\n      </md-dialog>\n    `;\n  }\n\n  override render() {\n    return html`\n      ${this.renderSourceDialog()}\n      <div class=\"chat-window\" id=\"chat-window\">\n        <div class=\"chat-messages\" id=\"chat-messages\">\n          <ps-ai-chat-element\n            ?hidden=\"${!this.defaultInfoMessage}\"\n            class=\"chatElement bot-chat-element\"\n            .detectedLanguage=\"${this.language}\"\n            .message=\"${this.defaultInfoMessage}\"\n            type=\"welcomeMessage\"\n            sender=\"bot\"\n          ></ps-ai-chat-element>\n          ${this.chatLog\n            .filter(chatElement => !chatElement.hidden)\n            .map(\n              chatElement => html`\n                <ps-ai-chat-element\n                  ?thinking=\"${chatElement.type === 'thinking' ||\n                  chatElement.type === 'noStreaming'}\"\n                  @followup-question=\"${this.followUpQuestion}\"\n                  @ps-open-source-dialog=\"${this.openSourceDialog}\"\n                  .clusterId=\"${this.clusterId}\"\n                  class=\"chatElement ${chatElement.sender}-chat-element\"\n                  .detectedLanguage=\"${this.language}\"\n                  .wsMessage=\"${chatElement}\"\n                  .message=\"${chatElement.message}\"\n                  @scroll-down-enabled=\"${() => (this.userScrolled = false)}\"\n                  .type=\"${chatElement.type}\"\n                  .sender=\"${chatElement.sender}\"\n                ></ps-ai-chat-element>\n              `\n            )}\n        </div>\n        <div class=\"layout horizontal center-center chat-input\">\n          ${this.renderChatInput()}\n        </div>\n      </div>\n    `;\n  }\n}\n"]}